{% extends "base.html" %}
{% block title %}Dashboard â€” Chaos Bot{% endblock %}
{% block content %}
<h1 style="margin: 1rem 0;">Dashboard</h1>

<div class="grid grid-4">
    <div class="card">
        <div class="stat">
            <div class="value" id="status-text">--</div>
            <div class="label">Status</div>
        </div>
    </div>
    <div class="card">
        <div class="stat">
            <div class="value" id="vlan-text">--</div>
            <div class="label">Current VLAN</div>
        </div>
    </div>
    <div class="card">
        <div class="stat">
            <div class="value" id="ip-text">--</div>
            <div class="label">Source IP</div>
        </div>
    </div>
    <div class="card">
        <div class="stat">
            <div class="value" id="cycle-text">0</div>
            <div class="label">Cycles</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>Attack</h2>
    <div class="attack-form">
        <div class="attack-row">
            <label class="attack-label">Target VLAN</label>
            <select id="attack-vlan" onchange="onVlanChange()">
                <option value="">Loading...</option>
            </select>
        </div>
        <div class="attack-row">
            <label class="attack-label">Modules</label>
            <div id="attack-modules" class="checkbox-row"></div>
        </div>
        <div class="attack-row">
            <label class="attack-label">Action</label>
            <div class="controls">
                <button class="btn btn-primary" id="btn-attack" onclick="runAttack()">Run Attack</button>
                <button class="btn" id="btn-hop" onclick="runHop()">Hop to VLAN</button>
                <button class="btn btn-danger" id="btn-stop" onclick="apiPost('/api/v1/stop')">Stop</button>
            </div>
        </div>
        <div class="attack-row">
            <label class="attack-label">Targets</label>
            <div id="attack-targets" class="target-summary">Select a VLAN</div>
        </div>
    </div>
    <div class="feedback" id="attack-feedback"></div>
</div>

<div class="card">
    <h2>Daemon Mode</h2>
    <div class="attack-row" style="margin-bottom: 0.75rem;">
        <label class="attack-label">VLANs to hop</label>
        <div id="daemon-vlans" class="checkbox-row"></div>
    </div>
    <div class="controls">
        <button class="btn btn-primary" id="btn-daemon-start" onclick="startDaemon()">Start Daemon</button>
        <button class="btn btn-danger" id="btn-daemon-stop" onclick="apiPost('/api/v1/stop')">Stop Daemon</button>
    </div>
</div>

<div class="card">
    <h2>Live Activity</h2>
    <div class="log-viewer" id="activity-log" style="max-height: 200px; font-size: 0.75rem;"></div>
</div>

<div class="card">
    <h2>Suricata Alerts <a href="https://evebox.lab.chettv.com" target="_blank" style="font-size: 0.75rem; font-weight: normal; text-transform: none; letter-spacing: 0;">(Open EveBox)</a></h2>
    <div class="controls">
        <button class="btn" onclick="loadAlerts('3600s')">Last Hour</button>
        <button class="btn" onclick="loadAlerts('86400s')">Last 24h</button>
        <button class="btn" onclick="loadAlerts('604800s')">Last 7d</button>
    </div>
    <div id="alert-summary" style="margin: 0.75rem 0;">
        <span style="color: var(--text-muted);">Loading alerts...</span>
    </div>
    <table id="alert-table" style="display: none;">
        <thead>
            <tr><th>Signature</th><th>Src</th><th>Dst</th><th>Count</th><th>Latest</th></tr>
        </thead>
        <tbody id="alert-tbody"></tbody>
    </table>
</div>

<div class="card">
    <h2>Recent Lease History</h2>
    <table>
        <thead>
            <tr><th>VLAN</th><th>IP</th><th>MAC</th><th>Time</th><th>Duration</th><th>Modules</th></tr>
        </thead>
        <tbody>
        {% for lease in recent_leases %}
            <tr>
                <td>{{ lease.vlan_id }}</td>
                <td>{{ lease.ip }}</td>
                <td>{{ lease.mac }}</td>
                <td>{{ lease.timestamp }}</td>
                <td>{{ lease.duration_sec }}s</td>
                <td>{{ lease.modules_run }}</td>
            </tr>
        {% else %}
            <tr><td colspan="6" style="color: var(--text-muted);">No lease history yet</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
var _vlans = [];
var _modules = [];

function refreshStatus() {
    fetch('/api/v1/status')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById('status-text').textContent = data.status || 'idle';
            document.getElementById('vlan-text').textContent = data.current_vlan || '--';
            document.getElementById('ip-text').textContent = data.current_ip || '--';
            document.getElementById('cycle-text').textContent = data.cycle_count || 0;

            var el = document.getElementById('status-text');
            if (data.status === 'attacking') el.style.color = '#f85149';
            else if (data.status === 'hopping') el.style.color = '#d29922';
            else if (data.status === 'cooldown') el.style.color = '#3fb950';
            else el.style.color = '#8b949e';

            var busy = (data.status === 'attacking' || data.status === 'hopping');
            setDisabled('btn-attack', busy);
            setDisabled('btn-hop', busy);
            setDisabled('btn-stop', data.status === 'idle');
            setDisabled('btn-daemon-start', busy);
            setDisabled('btn-daemon-stop', data.status === 'idle');
        })
        .catch(function() {});
}

function setDisabled(id, val) {
    var el = document.getElementById(id);
    if (el) el.disabled = val;
}

function apiPost(url, body) {
    var opts = {method: 'POST', headers: {'Content-Type': 'application/json'}};
    if (body) opts.body = JSON.stringify(body);
    fetch(url, opts)
        .then(function(r) { return r.json(); })
        .then(function(data) { console.log(data); refreshStatus(); })
        .catch(function(err) { console.error(err); });
}

function loadData() {
    // Load VLANs and targets
    fetch('/api/v1/targets')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            _vlans = data.vlans || [];
            var sel = document.getElementById('attack-vlan');
            sel.innerHTML = '<option value="all">All VLANs</option>';
            _vlans.forEach(function(v) {
                var opt = document.createElement('option');
                opt.value = v.id;
                var targets = v.targets || [];
                var count = targets.length === 1 && targets[0].indexOf('/') !== -1 ? 'subnet' : targets.length + ' hosts';
                opt.textContent = 'VLAN ' + v.id + ' - ' + v.name + ' (' + count + ')';
                sel.appendChild(opt);
            });

            // Daemon VLAN checkboxes
            var daemonDiv = document.getElementById('daemon-vlans');
            daemonDiv.innerHTML = '';
            _vlans.forEach(function(v) {
                var label = document.createElement('label');
                label.className = 'cb-label';
                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = v.id;
                cb.checked = true;
                label.appendChild(cb);
                label.appendChild(document.createTextNode('VLAN ' + v.id + ' - ' + v.name));
                daemonDiv.appendChild(label);
            });

            onVlanChange();
        });

    // Load modules
    fetch('/api/v1/modules')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            _modules = data.modules || [];
            var container = document.getElementById('attack-modules');
            container.innerHTML = '';
            _modules.forEach(function(mod) {
                var label = document.createElement('label');
                label.className = 'cb-label';
                var cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = mod.name;
                cb.checked = mod.enabled;
                cb.className = 'module-cb';
                label.appendChild(cb);
                label.appendChild(document.createTextNode(mod.name));
                container.appendChild(label);
            });
        });
}

function onVlanChange() {
    var sel = document.getElementById('attack-vlan');
    var div = document.getElementById('attack-targets');
    var val = sel.value;

    if (val === 'all') {
        var total = 0;
        _vlans.forEach(function(v) { total += (v.targets || []).length; });
        div.textContent = 'All targets across ' + _vlans.length + ' VLANs (' + total + ' entries)';
        return;
    }

    var vlan = _vlans.find(function(v) { return v.id == val; });
    if (!vlan) { div.textContent = 'No VLAN selected'; return; }

    var targets = vlan.targets || [];
    if (targets.length === 0) {
        div.textContent = 'No targets on VLAN ' + vlan.id;
    } else {
        div.textContent = targets.join(', ');
    }
}

function getSelectedModules() {
    return Array.from(document.querySelectorAll('.module-cb:checked')).map(function(cb) { return cb.value; });
}

function getTargetsForVlan() {
    var sel = document.getElementById('attack-vlan');
    var val = sel.value;
    var targets = [];
    if (val === 'all') {
        _vlans.forEach(function(v) {
            (v.targets || []).forEach(function(t) { targets.push(t); });
        });
    } else {
        var vlan = _vlans.find(function(v) { return v.id == val; });
        if (vlan) targets = vlan.targets || [];
    }
    return targets;
}

function runAttack() {
    var modules = getSelectedModules();
    var targets = getTargetsForVlan();
    var feedback = document.getElementById('attack-feedback');

    if (modules.length === 0) { feedback.textContent = 'Select at least one module'; feedback.style.color = 'var(--red)'; return; }
    if (targets.length === 0) { feedback.textContent = 'No targets for selected VLAN'; feedback.style.color = 'var(--red)'; return; }

    feedback.textContent = 'Running...';
    feedback.style.color = 'var(--yellow)';

    fetch('/api/v1/trigger', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({modules: modules, targets: targets})
    })
    .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
    .then(function(res) {
        if (res.ok) {
            feedback.textContent = 'Running: ' + res.data.modules.join(', ') + ' on ' + res.data.targets.length + ' target(s)';
            feedback.style.color = 'var(--green)';
        } else {
            feedback.textContent = res.data.error || 'Error';
            feedback.style.color = 'var(--red)';
        }
        refreshStatus();
    })
    .catch(function(err) {
        feedback.textContent = 'Error: ' + err;
        feedback.style.color = 'var(--red)';
    });
}

function runHop() {
    var sel = document.getElementById('attack-vlan');
    var val = sel.value;
    if (val === 'all') {
        apiPost('/api/v1/hop');
    } else {
        apiPost('/api/v1/start', {vlans: [parseInt(val)], once: true});
    }
    document.getElementById('attack-feedback').textContent = 'Hop triggered to VLAN ' + (val === 'all' ? '(random)' : val);
    document.getElementById('attack-feedback').style.color = 'var(--yellow)';
}

function startDaemon() {
    var checked = document.querySelectorAll('#daemon-vlans input[type="checkbox"]:checked');
    var vlans = Array.from(checked).map(function(cb) { return parseInt(cb.value); });
    apiPost('/api/v1/start', vlans.length > 0 ? {vlans: vlans} : null);
}

function loadAlerts(timeRange) {
    var summary = document.getElementById('alert-summary');
    var table = document.getElementById('alert-table');
    var tbody = document.getElementById('alert-tbody');
    summary.innerHTML = '<span style="color: var(--yellow);">Loading alerts...</span>';

    fetch('/api/v1/alerts?time_range=' + timeRange)
        .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
        .then(function(res) {
            if (!res.ok || res.data.error) {
                var errMsg = res.data.error || 'Failed to load';
                if (errMsg.indexOf('unreachable') !== -1 || errMsg.indexOf('timed out') !== -1) {
                    errMsg = 'EveBox unavailable';
                }
                summary.innerHTML = '<span style="color: var(--yellow);">' + errMsg + '</span>';
                table.style.display = 'none';
                return;
            }
            var alerts = res.data.events || res.data.alerts || [];
            if (alerts.length === 0) {
                summary.innerHTML = '<span style="color: var(--green);">No alerts</span>';
                table.style.display = 'none';
                return;
            }
            var total = alerts.reduce(function(sum, a) {
                return sum + ((a._metadata || {}).count || 1);
            }, 0);
            summary.innerHTML = '<span style="color: var(--red);">' + total + ' alert(s) in ' + alerts.length + ' group(s)</span>';
            tbody.innerHTML = '';
            alerts.slice(0, 25).forEach(function(alert) {
                var source = alert._source || {};
                var meta = alert._metadata || {};
                var alertInfo = source.alert || {};
                var tr = document.createElement('tr');
                var ts = meta.max_timestamp || source.timestamp || '--';
                if (ts !== '--') { try { ts = new Date(ts).toLocaleString(); } catch(e) {} }
                tr.innerHTML = '<td>' + (alertInfo.signature || '--') + '</td><td>' + (source.src_ip || '--') + '</td><td>' + (source.dest_ip || '--') + '</td><td>' + (meta.count || 1) + '</td><td>' + ts + '</td>';
                tbody.appendChild(tr);
            });
            table.style.display = 'table';
        })
        .catch(function(err) {
            summary.innerHTML = '<span style="color: var(--red);">Error: ' + err + '</span>';
            table.style.display = 'none';
        });
}

// Live activity SSE
var activityLog = document.getElementById('activity-log');
var activitySource = new EventSource('/api/v1/logs');
activitySource.onmessage = function(e) {
    try {
        var entry = JSON.parse(e.data);
        var line = '[' + entry.timestamp.substring(11, 19) + '] ' + entry.level + ' ' + entry.module + ': ' + entry.message;
        activityLog.textContent += line + '\n';
        var lines = activityLog.textContent.split('\n');
        if (lines.length > 100) activityLog.textContent = lines.slice(-100).join('\n');
        activityLog.scrollTop = activityLog.scrollHeight;
    } catch(ex) {
        activityLog.textContent += e.data + '\n';
        activityLog.scrollTop = activityLog.scrollHeight;
    }
};
activitySource.onerror = function() {
    activityLog.textContent += '[reconnecting...]\n';
};

loadData();
loadAlerts('86400s');
refreshStatus();
setInterval(refreshStatus, 3000);
</script>
{% endblock %}
